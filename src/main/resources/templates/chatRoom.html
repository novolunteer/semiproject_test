<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>chatRoom.html</title>
    <style>
      .chat-container {
        width: 400px;
        height: 600px;
        border: 1px solid #ddd;
        display: flex;
        flex-direction: column;
      }

      .chat-messages {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
        background: #f9f9f9;
      }

      .message {
        margin-bottom: 10px;
        display: flex;
      }

      .message.me {
        justify-content: flex-end;
      }

      .message.other {
        justify-content: flex-start;
      }

      .bubble {
        max-width: 70%;
        padding: 8px 12px;
        border-radius: 16px;
        font-size: 14px;
        line-height: 1.4;
        word-break: break-word;
      }

      .message.me .bubble {
        background: #dcf8c6;
        border-bottom-right-radius: 4px;
      }

      .message.other .bubble {
        background: #fff;
        border: 1px solid #ddd;
        border-bottom-left-radius: 4px;
      }

      .chat-input {
        display: flex;
        padding: 10px;
        border-top: 1px solid #ddd;
        background: #fff;
      }

      .chat-input input {
        flex: 1;
        padding: 8px 10px;
        border-radius: 20px;
        border: 1px solid #ccc;
      }

      .chat-input button {
        margin-left: 5px;
        padding: 8px 12px;
      }


    </style>
</head>
<body>
<div class="chat-container">
    <!-- 접속 상태 표시 -->
    <div id="presence" style="font-size:12px;color:gray; padding:5px;">
        연결 중...
    </div>

    <!-- 메시지 영역 -->
  <div class="chat-messages" id="chatMessages">
    <div th:each="msg:${messages}" th:class="${msg.sender_id == user_id} ? 'message me' : 'message other'">
      <div class="bubble">
        <span th:text="${msg.content}"></span>
      </div>
    </div>
  </div>

  <!-- 입력 영역 -->
  <div>
    <form class="chat-input">
      <input type="hidden" name="room_id" th:value="${room_id}">
      <input type="hidden" name="sender_id" th:value="${user_id}">

      <input type="text" name="content" placeholder="메시지를 입력하세요." required
             autocomplete="off" onkeydown="if(event.key == 'Enter'){this.form.submit();}">
      <button type="submit">전송</button>
    </form>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script th:inline="javascript">
    const chatBox = document.getElementById("chatMessages");
    const form = document.querySelector(".chat-input");
    const input = form.querySelector("input[name='content']");
    const room_id = /*[[${room.room_id}]]*/ 0; // Thymeleaf에서 방 번호 넣기
    const user_id = /*[[${user_id}]]*/ 0;       // 내 ID

    // 스크롤 내려주는 함수
    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // 메시지 화면에 추가하는 함수
    function addMessage(msg, sender_id) {
        const div = document.createElement("div");
        div.className = sender_id == user_id ? "message me" : "message other";
        div.innerHTML = `<div class="bubble">${msg}</div>`;
        chatBox.appendChild(div);
        scrollToBottom();
    }

    // STOMP 웹소켓 연결
    let stompClient = null;
    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({
            roomId: room_id,
            userId: user_id
        },
            function(frame) {
            console.log("웹소켓 연결됨");

            //presence 구독
            stompClient.subscribe('/topic/presence/' + room_id, function(message) {
                const count = parseInt(message.body);
                const el = document.getElementById("presence");

                if (count > 1) {
                    el.innerText = "상대 접속 중";
                } else {
                    el.innerText = "상대 오프라인";
                }
            });

            // 채팅방 구독
            stompClient.subscribe('/topic/chat/' + room_id, function(message) {
                const data = JSON.parse(message.body);

                // 내가 보낸 메시지는 다시 그리지 않음
                if (data.sender_id === user_id) return;

                addMessage(data.content, data.sender_id);
            });

            //채팅방 입장 알림
            stompClient.send("/app/chat/enter", {}, JSON.stringify({
               roomId: room_id,
               userId: user_id
           }));
        });

    }

    connect();

    // 메시지 보내기
    function sendMessage(content) {
        if(!content || content.trim() === "") return;

        const msg = {
            room_id: room_id,
            sender_id: user_id,
            content: content
        };

        // ⭐ 내가 보낸 메시지 즉시 화면에 추가
        addMessage(content, user_id);

        stompClient.send("/app/chat/message", {}, JSON.stringify(msg));
    }

    // 입력 이벤트 처리
    form.addEventListener("submit", function(e) {
        e.preventDefault();
        sendMessage(input.value);
        input.value = "";
    });

    // 초기 스크롤 위치
    scrollToBottom();

    // 페이지 떠날 때 채팅방 퇴장 처리
    window.addEventListener("beforeunload", function () {
        if (stompClient && stompClient.connected) {
            stompClient.send("/app/chat/leave", {}, JSON.stringify({
                roomId: room_id,
                userId: user_id
            }));
        }
    });

</script>
</body>
</html>