<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>chatRoom.html</title>
    <style>
      .chat-container {
        width: 400px;
        height: 600px;
        border: 1px solid #ddd;
        display: flex;
        flex-direction: column;
      }

      .chat-messages {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
        background: #f9f9f9;
      }

      .message {
        margin-bottom: 10px;
        display: flex;
          align-items: flex-end;
      }

      .message.me {
        justify-content: flex-end;
      }

      .message.other {
        justify-content: flex-start;
      }

      .message .read {
          font-size: 10px;     /* 글자 작게 */
          color: gray;         /* 옅은 회색 */
          margin-right: 5px;    /* 말풍선과 간격 */
          align-self: flex-end;/* 오른쪽 끝 정렬 */
          line-height: 1.4;
      }


      .bubble {
        max-width: 70%;
        padding: 8px 12px;
        border-radius: 16px;
        font-size: 14px;
        line-height: 1.4;
        word-break: break-word;
      }

      .message.me .bubble {
        background: #dcf8c6;
        border-bottom-right-radius: 4px;
      }

      .message.other .bubble {
        background: #fff;
        border: 1px solid #ddd;
        border-bottom-left-radius: 4px;
      }

      .chat-input {
        display: flex;
        padding: 10px;
        border-top: 1px solid #ddd;
        background: #fff;
      }

      .chat-input input {
        flex: 1;
        padding: 8px 10px;
        border-radius: 20px;
        border: 1px solid #ccc;
      }

      .chat-input button {
        margin-left: 5px;
        padding: 8px 12px;
      }


    </style>
</head>
<body>
<div class="chat-container">
    <!-- 접속 상태 표시 -->
    <div id="presence" style="font-size:12px;color:gray; padding:5px;">
        연결 중...
    </div>

    <!-- 메시지 영역 -->
  <div class="chat-messages" id="chatMessages">
    <div th:each="msg:${messages}"
         th:attr="data-id=${msg.message_id}"
         th:class="${msg.sender_id == user_id} ? 'message me' : 'message other'">
        <div class="bubble" th:text="${msg.content}">
      </div>
    </div>
  </div>

  <!-- 입력 영역 -->
  <div>
    <div class="chat-input">
      <input type="hidden" name="room_id" th:value="${room_id}">
      <input type="hidden" name="sender_id" th:value="${user_id}">

      <input type="text" id="messageInput" name="content" placeholder="메시지를 입력하세요."
             autocomplete="off">
      <button type="button" onclick="handleSend()">전송</button>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script th:inline="javascript">
    const chatBox = document.getElementById("chatMessages");
    const room_id = /*[[${room_id}]]*/ 0; // Thymeleaf에서 방 번호 넣기
    const user_id = /*[[${user_id}]]*/ 0;       // 내 ID

    console.log("room_id: " + room_id + ", user_id: " + user_id);

    // 스크롤 내려주는 함수
    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // 메시지 화면에 추가하는 함수
    function addMessage(msg, sender_id, message_id, is_read=0) {
        const div = document.createElement("div");
        div.className = sender_id == user_id ? "message me" : "message other";
        div.dataset.id = message_id;

        let readSpan = "";
        if(sender_id === user_id && is_read){
            readSpan = `<span class="read">읽음</span>`;
        }

        //내가 보낸 메시지일 경우 readSpan이 앞에 오도록
        if(sender_id === user_id){
            div.innerHTML = `
                ${readSpan}
                <div class="bubble">
                    ${msg}
                </div>
                `;
        }else { //상대방이 보낸 메시지
            div.innerHTML = `<div class="bubble">${msg}</div>`;
        }


        chatBox.appendChild(div);
        scrollToBottom();
    }

    window.onload = function (){
        scrollToBottom();
    }

    //읽음 표시를 갱신하는 함수
    function updateReadStatus(lastReadMessageId){
        //기존의 모든 읽음 표시 제거
        document.querySelectorAll(".message.me .read").forEach(span => span.remove());
        //특정 메시지에만 읽음 표시 추가
        const messageElement = document.querySelector(`.message.me[data-id="${lastReadMessageId}"]`);
        if(messageElement){
            const readSpan = document.createElement("span");
            readSpan.className = "read";
            readSpan.innerText="읽음";
            const bubble = messageElement.querySelector(".bubble");
            messageElement.insertBefore(readSpan, bubble);
        }
    }

    // STOMP 웹소켓 연결
    let stompClient = null;
    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({
            roomId: room_id,
            userId: user_id
        },
            function(frame) {
            console.log("웹소켓 연결됨");

            //presence 구독
            stompClient.subscribe('/topic/presence/' + room_id, function(message) {
                const count = parseInt(message.body);
                const el = document.getElementById("presence");

                if (count > 1) {
                    el.innerText = "상대 접속 중";
                } else {
                    el.innerText = "상대 오프라인";
                }
            });

            // 채팅방 구독
            stompClient.subscribe('/topic/chat/' + room_id, function(message) {
                const data = JSON.parse(message.body);

                if(data.sender_id === user_id){ //내가 보낸 메시지가 새로 도착하면
                    document.querySelectorAll(".message.me .read").forEach(span => span.remove());
                }

                addMessage(data.content, data.sender_id, data.message_id);
            });


           //읽음 이벤트 구독
           stompClient.subscribe('/user/queue/read-status/' + room_id, function(message) {
               const lastReadId = parseInt(message.body);
               console.log("읽음 상태 갱신 요청: ", lastReadId);
               updateReadStatus(lastReadId);
           });

                //채팅방 입장 알림
                stompClient.send("/app/chat/enter", {}, JSON.stringify({
                    roomId: room_id,
                    userId: user_id
                }));
        });

    }

    connect();

    const input = document.getElementById("messageInput");

    // 메시지 보내기
    function sendMessage(content) {
        if(!stompClient || !content || content.trim() === "") return;

        const msg = {
            room_id: room_id,
            sender_id: user_id,
            content: content
        };

        document.querySelectorAll(".message.me .read").forEach(span => span.remove());
        stompClient.send("/app/chat/message", {}, JSON.stringify(msg));
    }

    function handleSend() {
        sendMessage(input.value);
        input.value = "";
    }

    input.addEventListener("keydown", function(e){
        if(e.key === "Enter"){
            e.preventDefault(); // ⭐ 중요
            handleSend();
        }
    });

    // 페이지 떠날 때 채팅방 퇴장 처리
    window.addEventListener("beforeunload", function () {
        if (stompClient && stompClient.connected) {
            stompClient.send("/app/chat/leave", {}, JSON.stringify({
                roomId: room_id,
                userId: user_id
            }));
        }
    });

    //최초 로딩 시 메시지들의 is_read 값을 기반으로 읽음 표시
    document.querySelectorAll(".message.me").forEach(messageEl => {
        if(messageEl.querySelector(".read")){

        }
    });

</script>
</body>
</html>